(function() {  "use strict";

  /**
   * WooCommerce CSV Import Suite Admin scripts
   *
   * @since 3.0.0
   */
  jQuery(document).ready(function($) {

    /**
    	 * Dismiss import finished (either completed or failed) notice
    	 *
    	 * @since 3.0.3-1
    	 * @param {string} import_id Import job id
     */
    var dismiss_notice;
    dismiss_notice = function(import_id) {
      return $.get(ajaxurl, {
        action: 'wc_plugin_framework_csv_import_suite_dismiss_notice',
        messageid: 'wc_csv_import_suite_finished_' + import_id
      });
    };

    /**
    	 * Draw import results chart
    	 *
    	 * @since 3.0.3-1
    	 * @param {string} highlight Optional, series to highlight
     */
    wc_csv_import_suite.draw_results_chart = function(highlight) {
      var $container, highlight_series, series;
      series = [];
      if (!wc_csv_import_suite.status_counts) {
        return;
      }
      $container = $('.chart-placeholder.import-results');
      if (!$container.length) {
        return;
      }
      $.each(wc_csv_import_suite.status_counts, function(status, count) {
        return series.push({
          label: wc_csv_import_suite.chart_legends[status].title,
          color: wc_csv_import_suite.chart_legends[status].color,
          data: count
        });
      });
      if (highlight !== 'undefined' && series[highlight]) {
        highlight_series = series[highlight];
        highlight_series.color = '#9c5d90';
      }
      return $.plot($container, series, {
        grid: {
          hoverable: true
        },
        series: {
          pie: {
            show: true,
            radius: 1,
            innerRadius: 0.6,
            label: {
              show: false
            }
          },
          enable_tooltip: true,
          append_tooltip: wc_csv_import_suite.i18n.chart_tooltip.replace('%s', '')
        },
        legend: {
          show: false
        }
      });
    };

    /**
    	 * Display import progress for the import job
    	 *
    	 * @since 3.0.0
    	 * @param {string} import_id import job id
     */
    wc_csv_import_suite.display_import_progress = function(import_id) {
      var check, data, details_toggler_shown, last_result, processed_items, processed_lines, progress, running, total, ui;
      processed_lines = wc_csv_import_suite.results ? Object.keys(wc_csv_import_suite.results) : [];
      processed_items = processed_lines ? processed_lines.length : 0;
      last_result = processed_lines.length ? Number(processed_lines.pop()) : 0;
      total = wc_csv_import_suite.file_size;
      progress = wc_csv_import_suite.progress || 0;
      running = false;
      details_toggler_shown = false;
      data = {
        action: 'wc_csv_import_suite_get_progress',
        security: wc_csv_import_suite.progress_nonce,
        job_id: import_id
      };
      ui = {
        bar: $('#wc-csv-import-suite-progress .bar'),
        count: $('#wc-csv-import-suite-progress .processed-count'),
        percentage: $('#wc-csv-import-suite-progress .percentage'),
        results: $('#wc-csv-import-suite-results')
      };
      return check = setInterval(function() {
        if (running) {
          return;
        }
        running = true;
        data.results_from = last_result + 1;
        return $.get(ajaxurl, data).done(function(response) {
          var css_class, message, percentage, some_skipped_or_failed;
          if ('string' === typeof response) {
            message = wc_csv_import_suite.i18n.unexpected_error_message;
            $('.wrap h2:first').after('<div class="notice notice-error"><p>' + message + '</p></div>');
            return clearInterval(check);
          }
          progress = response.progress || 0;
          percentage = Math.round(progress / total * 100);
          if (response.results) {
            last_result = Number(Object.keys(response.results).pop());
            $.each(response.results, function(line, result) {
              var status;
              if (ui.results.find('tr.line-' + line).length) {
                return;
              }
              status = $('<span />').text(result.status).text();
              message = $('<span />').text(result.message).text();
              wc_csv_import_suite.status_counts[status]++;
              processed_items++;
              ui.results.find('li.' + status + ' .amount').text(wc_csv_import_suite.status_counts[status]);
              if (status === 'skipped' || status === 'failed') {
                ui.results.find('.results-details > tbody').append('<tr class="line-' + line + ' ' + status + '"><td>' + line + '</td><td>' + wc_csv_import_suite.chart_legends[status].label + '</td><td>' + message + '</td></tr>');
                if (!details_toggler_shown) {
                  ui.results.find('.js-wc-csv-import-suite-results-details-link-widget').show();
                  return details_toggler_shown = true;
                }
              }
            });
          }
          ui.count.text(processed_items);
          ui.percentage.text(percentage + ' %');
          ui.bar.css('width', percentage + '%');
          wc_csv_import_suite.draw_results_chart();
          running = false;
          if (progress >= total) {
            clearInterval(check);
            progress = total;
            some_skipped_or_failed = wc_csv_import_suite.status_counts.failed || wc_csv_import_suite.status_counts.skipped;
            css_class = some_skipped_or_failed ? 'notice-warning' : 'notice-success';
            message = wc_csv_import_suite.i18n.import_complete;
            if (some_skipped_or_failed) {
              message += ' ' + wc_csv_import_suite.i18n.skipped_or_failed_lines;
            }
            $('h2:first').after('<div class="notice ' + css_class + '"><p>' + message + '</p></div>');
            $('.notice-dry-run p').html(wc_csv_import_suite.i18n.dry_run_complete);
            $('.progress-bar .js-spinner').fadeOut();
            $('.js-notice-safe-to-leave-screen').remove();
            return dismiss_notice(import_id);
          }
        }).fail(function(jqXHR, textStatus, error) {
          var message;
          message = wc_csv_import_suite.i18n.unexpected_error_message;
          return $('.wrap h2:first').after('<div class="notice notice-error"><p>' + message + '</p></div>');
        });
      }, 1000);
    };

    /* IMPORT PROGRESS/RESULTS SCREEN */
    $('.js-wc-csv-import-suite-toggle-results-details').click(function(e) {
      var details_shown;
      e.preventDefault();
      $('#wc-csv-import-suite-results').find('.results-details').toggle();
      details_shown = $('#wc-csv-import-suite-results').find('.results-details').is(':visible');
      return $(this).find('.js-wc-csv-import-suite-toggle-results-details-text').text(details_shown ? wc_csv_import_suite.i18n.hide_details : wc_csv_import_suite.i18n.show_details);
    });
    $('.js-wc-csv-import-suite-highlight-series').hover(function() {
      return wc_csv_import_suite.draw_results_chart($(this).data('series'));
    }, function() {
      return wc_csv_import_suite.draw_results_chart();
    });
    $(window).resize((function() {
      return function() {
        var timeoutId;
        clearTimeout(timeoutId);
        return timeoutId = setTimeout(function() {
          timeoutId = null;
          return wc_csv_import_suite.draw_results_chart();
        }, 100);
      };
    })());

    /* IMPORT OPTIONS SCREEN */
    $('body').on('click', 'input.js-wc-csv-import-suite-merge', function(e) {
      var checked, toggle;
      checked = $(this).is(':checked');
      toggle = checked ? 'show' : 'hide';
      return $('#wc-csv-import-suite-insert-non-matching').closest('tr')[toggle]();
    });
    return $('body').on('change', 'select.js-wc-csv-import-suite-delimiter', function(e) {
      var data, delimiter;
      console.log('siin2');
      delimiter = $(this).val();
      $('.wc-csv-import-suite-preview-container').block({
        message: null,
        overlayCSS: {
          opacity: 0.3
        }
      });
      data = {
        action: 'wc_csv_import_suite_get_preview',
        security: wc_csv_import_suite.preview_nonce,
        delimiter: delimiter,
        file: $('.js-wc-csv-import-suite-file').val()
      };
      return $.get(ajaxurl, data, function(response) {
        $('#wc-csv-import-suite-preview').html(response);
        return $('.wc-csv-import-suite-preview-container').unblock();
      });
    });
  });

}).call(this);


